<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>é£Ÿäº‹è¨˜éŒ²ï¼ˆå¤©æ°—ä¿®æ­£ç‰ˆï¼‰</title>

<link rel="icon" href="icon.jpg">
<link rel="apple-touch-icon" href="icon.jpg">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root { --primary: #007AFF; --bg: #F2F2F7; --danger: #FF3B30; --success: #34C759; }
  
  body[data-user="boy"] { --theme-color: #007AFF; --theme-light: #E0F0FF; }
  body[data-user="girl"] { --theme-color: #FF2D55; --theme-light: #FFE0E6; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    background-color: var(--bg); margin: 0; padding: 0; color: #333;
    padding-bottom: 220px; 
    transition: background 0.3s;
  }

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆ */
  .user-switcher {
    display: flex; gap: 10px; padding: 10px 15px; background: #fff;
    justify-content: center; border-bottom: 1px solid #eee;
  }
  .user-btn {
    flex: 1; padding: 8px; border-radius: 20px; border: 2px solid transparent;
    font-weight: bold; background: #f0f0f0; color: #999; cursor: pointer;
    font-size: 0.9rem; transition: 0.2s;
  }
  body[data-user="boy"] .user-btn[data-target="boy"] { background: #007AFF; color: white; border-color: #0056b3; }
  body[data-user="girl"] .user-btn[data-target="girl"] { background: #FF2D55; color: white; border-color: #d6002a; }

  /* å¤©æ°—ã‚¨ãƒªã‚¢ */
  .weather-bar {
    background: linear-gradient(to right, #e0f7fa, #e1bee7);
    padding: 8px 15px; font-size: 0.85rem; color: #555;
    display: flex; justify-content: center; align-items: center; gap: 10px;
    border-bottom: 1px solid #ddd; font-weight: bold;
    min-height: 24px;
  }
  .weather-icon { font-size: 1.2rem; margin-right: 2px; }

  .sub-header {
    background: #fff; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .tools-bar {
    display: flex; justify-content: space-between; align-items: center; 
    padding: 8px 15px; border-bottom: 1px solid #f5f5f5;
  }
  .btn-tool {
    font-size: 0.8rem; background: none; border: 1px solid #ccc;
    padding: 5px 12px; border-radius: 15px; cursor: pointer; color: #555;
  }
  .btn-partner-copy {
    border-color: var(--theme-color); color: var(--theme-color); font-weight: bold;
    background: #fff; display: flex; align-items: center; gap: 4px;
  }
  .btn-partner-copy::before { content: 'ğŸ“‹'; font-size: 1rem; }

  .tabs { display: flex; width: 100%; }
  .tab-btn {
    flex: 1; padding: 12px; text-align: center; font-weight: bold; cursor: pointer;
    border-bottom: 3px solid transparent; color: #999;
  }
  .tab-btn.active {
    border-bottom-color: var(--theme-color); color: var(--theme-color); background: var(--theme-light);
  }

  .container { padding: 15px; }
  .category-title {
    font-size: 0.9rem; color: #666; margin: 20px 0 8px 5px; font-weight: bold;
    display: flex; align-items: center;
  }
  .category-title::before {
    content: ''; display: inline-block; width: 4px; height: 1em;
    background: var(--theme-color); margin-right: 6px; border-radius: 2px;
  }

  .list-card {
    background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 15px;
  }
  .item-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 15px; border-bottom: 1px solid #eee;
  }
  .item-row:last-child { border-bottom: none; }
  .item-name { font-weight: 500; font-size: 1rem; }

  .options { display: flex; gap: 5px; }
  .radio-label {
    padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd;
    font-size: 0.8rem; cursor: pointer; background: #fff; color: #666;
    min-width: 35px; text-align: center;
  }
  input[type="radio"] { display: none; }
  
  input[value="finish"]:checked + .radio-label { background-color: var(--success); color: white; border-color: var(--success); }
  input[value="left"]:checked + .radio-label { background-color: var(--danger); color: white; border-color: var(--danger); }
  input[value="none"]:checked + .radio-label { background-color: #eee; color: #aaa; border-color: #eee; }

  .other-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
  .other-label { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; display: block; }
  .other-input {
    width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 1rem; box-sizing: border-box; -webkit-appearance: none;
  }

  /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
  .chart-container {
    margin: 10px 15px 15px 15px; background: white; border-radius: 12px;
    padding: 10px 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    height: 350px; position: relative;
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer;
  }
  .chart-container:active { background-color: #fafafa; }

  .chart-title { 
    text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 0px; 
    font-weight: bold; width:100%; display: flex; justify-content: center; align-items: center; gap:5px;
  }
  .chart-title::after {
    content: '?'; display: inline-block; width: 18px; height: 18px; 
    background: #ccc; color: white; border-radius: 50%; 
    font-size: 12px; line-height: 18px; text-align: center;
  }

  .score-area {
    margin: 0 15px 30px 15px; background: white; border-radius: 12px;
    padding: 15px; text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid var(--theme-color);
  }
  .score-label { font-size: 0.9rem; color: #666; font-weight: bold; }
  .score-value { font-size: 2.2rem; font-weight: 800; color: var(--theme-color); line-height: 1.2; }
  .score-comment { font-size: 1rem; color: #333; margin-top: 5px; font-weight: bold; }

  .fixed-footer {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    padding: 15px 20px; box-sizing: border-box; border-top: 1px solid #ccc;
    z-index: 200;
  }
  .btn-copy {
    width: 100%; border: none; padding: 14px; border-radius: 12px;
    font-size: 1.1rem; font-weight: bold; cursor: pointer;
    background-color: var(--theme-color); color: white; transition: background 0.3s;
  }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 999; display: none;
    align-items: center; justify-content: center;
    animation: fadeIn 0.2s ease;
  }
  .modal-content {
    background: white; width: 85%; max-width: 320px; border-radius: 16px;
    padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center;
  }
  .modal-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; }
  .modal-btn-group { display: flex; flex-direction: column; gap: 10px; }
  .modal-btn {
    padding: 12px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold;
  }
  .btn-reset-one { background: #f0f0f0; color: #333; }
  .btn-reset-all { background: #ffe0e0; color: #FF3B30; }
  .btn-cancel { background: white; color: #007AFF; margin-top: 5px; }

  .nutrition-list { text-align: left; font-size: 0.9rem; line-height: 1.5; }
  .nutrition-item { margin-bottom: 15px; }
  .nut-label { font-weight: bold; display: block; margin-bottom: 2px; }
  .nut-desc { color: #666; font-size: 0.85rem; }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

</style>
</head>
<body data-user="boy">

<div id="weather-bar" class="weather-bar" style="display:none;">
  <span id="weather-date-label"></span>
  <span id="weather-icon" class="weather-icon"></span>
  <span id="weather-text"></span>
  <span style="margin-left:8px; color:#007AFF;">â˜‚ï¸<span id="weather-pop"></span>%</span>
  <span style="margin-left:8px;">
    <span style="color:#FF3B30;" id="temp-max">--</span>â„ƒ / 
    <span style="color:#007AFF;" id="temp-min">--</span>â„ƒ
  </span>
</div>

<div class="user-switcher">
  <button class="user-btn" data-target="boy" onclick="switchUser('boy')">ğŸŒ™ ç”·ã®å­</button>
  <button class="user-btn" data-target="girl" onclick="switchUser('girl')">ğŸµ å¥³ã®å­</button>
</div>

<div class="sub-header">
  <div class="tools-bar">
    <button id="btn-partner-copy" class="btn-tool btn-partner-copy" onclick="copyToPartner()">ğŸµã¸ã‚³ãƒ”ãƒ¼</button>
    <button class="btn-tool" onclick="showResetModal()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div class="tabs">
    <div class="tab-btn active" id="tab-morning" onclick="switchMeal('morning')">ğŸŒ… æœé£Ÿ</div>
    <div class="tab-btn" id="tab-dinner" onclick="switchMeal('dinner')">ğŸŒƒ å¤•é£Ÿ</div>
  </div>
</div>

<div class="container" id="list-container">
  <div style="text-align:center; margin-top:50px; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div class="container others-area">
  <div class="other-box">
    <label class="other-label">ãã®ä»–ï¼ˆå®Œé£Ÿï¼‰</label>
    <input type="text" id="other-finish" class="other-input" placeholder="ä¾‹ï¼šãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ" onchange="saveData()">
  </div>
  <div class="other-box">
    <label class="other-label" style="color: var(--danger);">ãã®ä»–ï¼ˆæ®‹ã—ï¼‰</label>
    <input type="text" id="other-left" class="other-input" placeholder="ä¾‹ï¼šé‡èœ" onchange="saveData()">
  </div>
</div>

<div class="chart-container" onclick="showNutritionHelp()">
  <div class="chart-title">æ „é¤Šãƒãƒ©ãƒ³ã‚¹ï¼ˆå®Œé£Ÿåˆ†ï¼‰</div>
  <div style="flex:1; width:100%; position:relative;">
    <canvas id="nutritionChart"></canvas>
  </div>
</div>

<div class="score-area">
  <div class="score-label">æ „é¤Šã‚¹ã‚³ã‚¢</div>
  <div class="score-value" id="score-text">0 <span style="font-size:1rem;">pt</span></div>
  <div class="score-comment" id="score-comment">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
</div>

<div class="fixed-footer">
  <button class="btn-copy" onclick="generateAndCopy()">ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ</button>
</div>

<div id="reset-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <div class="modal-btn-group">
      <button class="modal-btn btn-reset-one" onclick="resetCurrent()">è¡¨ç¤ºä¸­ã®é£Ÿäº‹ã®ã¿ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="modal-btn btn-reset-all" onclick="resetAll()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ<br><span style="font-size:0.8rem">(å…¨å“¡ãƒ»å…¨é£Ÿ)</span></button>
      <button class="modal-btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div id="nutrition-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">æ „é¤Šç´ ã®ãƒ’ãƒŸãƒ„</div>
    <div class="nutrition-list">
      <div class="nutrition-item">
        <span class="nut-label" style="color:#F5A623">ğŸ’› é»„ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰</span>
        <span class="nut-desc">ç‚­æ°´åŒ–ç‰©ã€æ²¹ã€ç ‚ç³–<br>ï¼ˆãƒ‘ãƒ³ã€ã”é£¯ã€ãƒãƒ†ãƒˆã€ç”˜æ —ãªã©ï¼‰</span>
      </div>
      <div class="nutrition-item">
        <span class="nut-label" style="color:#FF3B30">â¤ï¸ èµ¤ï¼ˆã‹ã‚‰ã ã‚’ä½œã‚‹ï¼‰</span>
        <span class="nut-desc">ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€ã‚«ãƒ«ã‚·ã‚¦ãƒ <br>ï¼ˆè‚‰ã€é­šã€åµã€ç‰›ä¹³ã€è±†ã€ãƒãƒ¼ã‚ºï¼‰</span>
      </div>
      <div class="nutrition-item">
        <span class="nut-label" style="color:#34C759">ğŸ’š ç·‘ï¼ˆèª¿å­ã‚’æ•´ãˆã‚‹ï¼‰</span>
        <span class="nut-desc">ãƒ“ã‚¿ãƒŸãƒ³ã€ãƒŸãƒãƒ©ãƒ«ã€é£Ÿç‰©ç¹Šç¶­<br>ï¼ˆé‡èœã€æœç‰©ï¼‰</span>
      </div>
    </div>
    <div class="modal-btn-group">
      <button class="modal-btn btn-cancel" onclick="closeNutritionModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
  import { firebaseConfig } from "./config.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.db = db;
  window.set = set;
  window.ref = ref;
  window.onValue = onValue;
  window.get = get;

  initApp();
</script>

<script>
  const CATEGORY_MAP = { 1: "ä¸»é£Ÿ", 2: "ä¸»èœ", 3: "å‰¯èœ", 4: "æ±ç‰©", 5: "ãƒ‡ã‚¶ãƒ¼ãƒˆ" };
  const AREA_CODE = "130000"; // æ±äº¬

  let currentUser = 'boy';   
  let currentMeal = 'morning'; 
  let menuData = { morning: {}, dinner: {} }; 
  let nutritionMap = {}; 
  let currentFirebaseData = { checks: {}, otherFinish: '', otherLeft: '' }; 
  let myChart = null;

  function initApp() {
    const lastUser = localStorage.getItem('fc_last_user');
    if(lastUser) currentUser = lastUser;

    const currentHour = new Date().getHours();
    if (currentHour >= 12) {
        currentMeal = 'dinner';
    } else {
        currentMeal = 'morning';
    }

    updateTheme();
    loadMenuCsv().then(() => {
      initChart();
      setupRealtimeListener(); 
      getWeather(); 
    });
  }

  // â˜…ä¿®æ­£ï¼šãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚’æ¢ç´¢ã—ã¦å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
  async function getWeather() {
    try {
      const url = `https://www.jma.go.jp/bosai/forecast/data/forecast/${AREA_CODE}.json`;
      const res = await fetch(url);
      const data = await res.json();

      const currentHour = new Date().getHours();
      const isPm = currentHour >= 12;

      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ—¥ä»˜
      const now = new Date();
      if (isPm) { now.setDate(now.getDate() + 1); } 
      const y = now.getFullYear();
      const m = (now.getMonth() + 1).toString().padStart(2, '0');
      const d = now.getDate().toString().padStart(2, '0');
      const targetDateStr = `${y}-${m}-${d}`;
      const targetLabel = isPm ? "æ˜æ—¥" : "ä»Šæ—¥";

      // ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã—ã¦æ ¼ç´
      let tsWeather = null;
      let tsPops = null;
      let tsTemps = null;

      // timeSeriesé…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã€ä¸­èº«ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§åˆ¤åˆ¥ã™ã‚‹
      data[0].timeSeries.forEach(ts => {
          const area = ts.areas[0];
          if(area.weatherCodes) tsWeather = ts;
          if(area.pops) tsPops = ts;
          if(area.tempsMin || area.tempsMax || area.temps) tsTemps = ts;
      });

      let weatherText = "--";
      let weatherIcon = "";
      let minTemp = "--";
      let maxTemp = "--";
      let maxPop = "--";

      // 1. å¤©æ°—
      if (tsWeather) {
          const idx = tsWeather.timeDefines.findIndex(td => td.startsWith(targetDateStr));
          if (idx !== -1 && tsWeather.areas[0].weatherCodes[idx]) {
              const code = tsWeather.areas[0].weatherCodes[idx];
              weatherText = getSimpleWeather(code);
              weatherIcon = getWeatherIcon(code);
          } else {
              // æœ€çµ‚æ‰‹æ®µï¼šPMãªã‚‰æœ€å¾Œã€AMãªã‚‰æœ€åˆ
              const fbIdx = isPm ? (tsWeather.areas[0].weatherCodes.length - 1) : 0;
              const code = tsWeather.areas[0].weatherCodes[fbIdx];
              weatherText = getSimpleWeather(code);
              weatherIcon = getWeatherIcon(code);
          }
      }

      // 2. æ°—æ¸©
      if (tsTemps) {
          const area = tsTemps.areas[0];
          const idx = tsTemps.timeDefines.findIndex(td => td.startsWith(targetDateStr));
          
          if (idx !== -1) {
              if (area.tempsMin && area.tempsMin[idx] && area.tempsMin[idx] !== "") minTemp = area.tempsMin[idx];
              if (area.tempsMax && area.tempsMax[idx] && area.tempsMax[idx] !== "") maxTemp = area.tempsMax[idx];
          } 
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ‰åŠ¹ãªå€¤ã®ãƒªã‚¹ãƒˆã‹ã‚‰æ¢ã™
          if (minTemp === "--" && area.tempsMin) {
              const valids = area.tempsMin.filter(v => v !== null && v !== "");
              if (valids.length > 0) minTemp = isPm ? valids[valids.length - 1] : valids[0];
          }
          if (maxTemp === "--" && area.tempsMax) {
              const valids = area.tempsMax.filter(v => v !== null && v !== "");
              if (valids.length > 0) maxTemp = isPm ? valids[valids.length - 1] : valids[0];
          }
      }

      // 3. é™æ°´ç¢ºç‡
      if (tsPops) {
          const indices = [];
          tsPops.timeDefines.forEach((td, i) => {
              if (td.startsWith(targetDateStr)) indices.push(i);
          });
          
          let pops = [];
          if (indices.length > 0) {
              pops = indices.map(i => parseInt(tsPops.areas[0].pops[i])).filter(n => !isNaN(n));
          } else {
              // æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€AMãªã‚‰å‰åŠã€PMãªã‚‰å¾ŒåŠ
              const allPops = tsPops.areas[0].pops;
              const half = Math.ceil(allPops.length / 2);
              const slice = isPm ? allPops.slice(-half) : allPops.slice(0, half);
              pops = slice.map(p => parseInt(p)).filter(n => !isNaN(n));
          }

          if (pops.length > 0) {
              maxPop = Math.max(...pops);
          }
      }

      document.getElementById('weather-date-label').textContent = targetLabel + "ï¼š";
      document.getElementById('weather-icon').textContent = weatherIcon;
      document.getElementById('weather-text').textContent = weatherText;
      document.getElementById('weather-pop').textContent = maxPop;
      document.getElementById('temp-min').textContent = minTemp;
      document.getElementById('temp-max').textContent = maxTemp;
      
      document.getElementById('weather-bar').style.display = 'flex';

    } catch (e) {
      console.log("Weather error: ", e);
    }
  }

  function getWeatherIcon(code) {
    const c = parseInt(code);
    if ([100, 101, 123, 124].includes(c)) return "â˜€ï¸";
    if ([102, 103, 104, 105, 106, 107, 108, 110, 111].includes(c)) return "â›…ï¸";
    if ([112, 113, 114, 115, 116, 117, 118, 119].includes(c)) return "â˜ï¸";
    if (c >= 200 && c < 300) return "â˜ï¸";
    if (c >= 300 && c < 400) return "â˜‚ï¸";
    if (c >= 400) return "â˜ƒï¸";
    return "ğŸŒ¥";
  }
  function getSimpleWeather(code) {
    const c = parseInt(code);
    if (c < 200) return "æ™´ã‚Œ";
    if (c < 300) return "ãã‚‚ã‚Š";
    if (c < 400) return "é›¨";
    return "é›ª";
  }

  function setupRealtimeListener() {
    const dataPath = `users/${currentUser}/${currentMeal}`;
    const dataRef = window.ref(window.db, dataPath);

    window.onValue(dataRef, (snapshot) => {
      const val = snapshot.val();
      if (val) {
        currentFirebaseData = val;
      } else {
        currentFirebaseData = { checks: {}, otherFinish: '', otherLeft: '' };
      }
      renderPage(); 
      updateChartAndScore(); 
    });
  }

  async function loadMenuCsv() {
    try {
      const response = await fetch('menu.csv?' + new Date().getTime());
      if (!response.ok) throw new Error("CSV error");
      const text = await response.text();
      parseCsv(text);
    } catch (e) {
      document.getElementById('list-container').innerHTML = `<div style="text-align:center; margin-top:20px;">menu.csvèª­è¾¼ã‚¨ãƒ©ãƒ¼</div>`;
    }
  }

  function parseCsv(text) {
    const lines = text.split(/\r\n|\n/);
    menuData = { morning: {}, dinner: {} };
    nutritionMap = {};
    
    Object.values(CATEGORY_MAP).forEach(cat => { menuData.morning[cat] = []; menuData.dinner[cat] = []; });
    
    lines.forEach(line => {
      const parts = line.split(',');
      if (parts.length < 6) return;
      const [m, c, item, y, r, g] = parts;
      const catName = CATEGORY_MAP[c.trim()];
      
      if (!catName) return;
      const itemName = item.trim();

      if (m.trim() === '1') menuData.morning[catName].push(itemName);
      else if (m.trim() === '2') menuData.dinner[catName].push(itemName);

      nutritionMap[itemName] = {
        yellow: parseInt(y) || 0,
        red: parseInt(r) || 0,
        green: parseInt(g) || 0
      };
    });
  }

  function renderPage() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${currentMeal}`).classList.add('active');
    
    const partnerBtn = document.getElementById('btn-partner-copy');
    partnerBtn.textContent = (currentUser === 'boy') ? 'ğŸµã¸ã‚³ãƒ”ãƒ¼' : 'ğŸŒ™ã¸ã‚³ãƒ”ãƒ¼';

    const container = document.getElementById('list-container');
    container.innerHTML = '';
    
    const savedData = currentFirebaseData;
    const checks = savedData.checks || {};

    Object.keys(menuData[currentMeal]).forEach(cat => {
      const items = menuData[currentMeal][cat];
      if (items.length === 0) return;

      const title = document.createElement('div');
      title.className = 'category-title';
      title.textContent = cat;
      container.appendChild(title);

      const card = document.createElement('div');
      card.className = 'list-card';

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item-row';
        const savedVal = checks[item] || 'none';
        const radioName = `radio_${item}`;

        row.innerHTML = `
          <div class="item-name">${item}</div>
          <div class="options">
            <label><input type="radio" name="${radioName}" value="finish" 
              ${savedVal === 'finish' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">å®Œé£Ÿ</span></label>
            <label><input type="radio" name="${radioName}" value="left" 
              ${savedVal === 'left' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">æ®‹ã—</span></label>
            <label><input type="radio" name="${radioName}" value="none" 
              ${savedVal === 'none' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">â€•</span></label>
          </div>
        `;
        card.appendChild(row);
      });
      container.appendChild(card);
    });

    const ofInput = document.getElementById('other-finish');
    const olInput = document.getElementById('other-left');
    if (document.activeElement !== ofInput) ofInput.value = savedData.otherFinish || '';
    if (document.activeElement !== olInput) olInput.value = savedData.otherLeft || '';
  }

  function initChart() {
    const ctx = document.getElementById('nutritionChart').getContext('2d');
    
    myChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['ğŸ’›ã‚¨ãƒãƒ«ã‚®ãƒ¼', 'â¤ï¸ã‹ã‚‰ã ä½œã‚Š', 'ğŸ’šèª¿å­ã‚’æ•´ãˆã‚‹'],
        datasets: [{
          label: 'æ‘‚å–ãƒãƒ©ãƒ³ã‚¹',
          data: [0, 0, 0],
          backgroundColor: 'rgba(0, 122, 255, 0.2)',
          borderColor: 'rgba(0, 122, 255, 1)',
          borderWidth: 3,
          pointRadius: 4,
          pointBackgroundColor: ['#FFCC00', '#FF3B30', '#34C759'],
          pointBorderColor: '#fff',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 5 },
        scales: {
          r: {
            angleLines: { display: true },
            suggestedMin: 0,
            suggestedMax: 8,
            pointLabels: {
              font: { size: 14, weight: 'bold' },
              color: '#555'
            },
            ticks: { display: false, stepSize: 2 }
          }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  function updateChartAndScore() {
    if (!myChart) return;

    let totalY = 0;
    let totalR = 0;
    let totalG = 0;

    const checks = currentFirebaseData.checks || {};

    Object.keys(checks).forEach(item => {
      if (checks[item] === 'finish' && nutritionMap[item]) {
        totalY += nutritionMap[item].yellow;
        totalR += nutritionMap[item].red;
        totalG += nutritionMap[item].green;
      }
    });

    myChart.data.datasets[0].data = [totalY, totalR, totalG];
    
    const color = currentUser === 'boy' ? '0, 122, 255' : '255, 45, 85';
    myChart.data.datasets[0].backgroundColor = `rgba(${color}, 0.2)`;
    myChart.data.datasets[0].borderColor = `rgba(${color}, 1)`;
    myChart.update();

    const totalScore = totalY + totalR + totalG;
    const scoreTextEl = document.getElementById('score-text');
    const commentEl = document.getElementById('score-comment');
    
    scoreTextEl.innerHTML = `${totalScore} <span style="font-size:1rem;">pt</span>`;

    let comment = "";
    if (totalScore === 0) {
        comment = "ä½•ã‚’é£Ÿã¹ã‚‹ã‹ãªï¼Ÿ";
    } else if (totalScore < 5) {
        comment = "ã‚‚ã†å°‘ã—é£Ÿã¹ã‚ˆã†ï¼ğŸ™";
    } else if (totalScore < 10) {
        comment = "è‰¯ã„èª¿å­ï¼ãã®èª¿å­ğŸ‘";
    } else if (totalScore < 15) {
        comment = "ãƒŠã‚¤ã‚¹ãƒãƒ©ãƒ³ã‚¹ï¼ç´ æ™´ã‚‰ã—ã„âœ¨";
    } else {
        comment = "ã‚¨ãƒãƒ«ã‚®ãƒ¼æº€ã‚¿ãƒ³ï¼å…ƒæ°—100å€ğŸ’ª";
    }
    commentEl.textContent = comment;
  }

  function switchUser(user) {
    currentUser = user;
    localStorage.setItem('fc_last_user', user);
    updateTheme();
    setupRealtimeListener(); 
  }

  function switchMeal(meal) {
    currentMeal = meal;
    setupRealtimeListener(); 
  }

  function updateTheme() {
    document.body.setAttribute('data-user', currentUser);
  }

  function saveData() {
    const data = {
      checks: {},
      otherFinish: document.getElementById('other-finish').value,
      otherLeft: document.getElementById('other-left').value
    };

    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
      const itemName = input.name.replace('radio_', '');
      data.checks[itemName] = input.value;
    });

    const dataPath = `users/${currentUser}/${currentMeal}`;
    window.set(window.ref(window.db, dataPath), data);
  }

  function showResetModal() {
    document.getElementById('reset-modal').style.display = 'flex';
  }
  function closeModal() {
    document.getElementById('reset-modal').style.display = 'none';
  }

  function showNutritionHelp() {
    document.getElementById('nutrition-modal').style.display = 'flex';
  }
  function closeNutritionModal() {
    document.getElementById('nutrition-modal').style.display = 'none';
  }

  function resetCurrent() {
    closeModal();
    const userName = currentUser === 'boy' ? 'ç”·ã®å­' : 'å¥³ã®å­';
    const mealName = currentMeal === 'morning' ? 'æœé£Ÿ' : 'å¤•é£Ÿ';
    if(!confirm(`ã€Œ${userName}ã€ã®ã€Œ${mealName}ã€ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const dataPath = `users/${currentUser}/${currentMeal}`;
    window.set(window.ref(window.db, dataPath), null);
  }

  function resetAll() {
    closeModal();
    if(!confirm("ã€æ³¨æ„ã€‘\nå…¨å“¡ã®å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
    const dataPath = `users`;
    window.set(window.ref(window.db, dataPath), null);
  }

  function copyToPartner() {
    const targetUser = currentUser === 'boy' ? 'girl' : 'boy';
    const targetName = currentUser === 'boy' ? 'å¥³ã®å­' : 'ç”·ã®å­';
    const mealName = currentMeal === 'morning' ? 'æœé£Ÿ' : 'å¤•é£Ÿ';
    if(!confirm(`ç¾åœ¨è¡¨ç¤ºä¸­ã®å†…å®¹ã‚’\nã€Œ${targetName}ã€ã®ã€Œ${mealName}ã€ã«\nä¸Šæ›¸ãã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const sourcePath = `users/${currentUser}/${currentMeal}`;
    const targetPath = `users/${targetUser}/${currentMeal}`;
    window.get(window.ref(window.db, sourcePath)).then((snapshot) => {
      if (snapshot.exists()) {
        window.set(window.ref(window.db, targetPath), snapshot.val());
        alert(`ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
      } else {
        alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      }
    });
  }

  function generateAndCopy() {
    let finished = [];
    let leftovers = [];

    const savedData = currentFirebaseData;
    const checks = savedData.checks || {};

    Object.keys(checks).forEach(itemName => {
        const val = checks[itemName];
        if (val === 'finish') finished.push(itemName);
        if (val === 'left') leftovers.push(itemName);
    });

    const otherF = savedData.otherFinish;
    const otherL = savedData.otherLeft;
    if(otherF) finished.push(otherF);
    if(otherL) leftovers.push(otherL);

    let resultText = "";
    if(finished.length > 0) resultText += `ï¼ˆå®Œé£Ÿï¼‰${finished.join("ã€")}\n`;
    if(leftovers.length > 0) resultText += `ï¼ˆæ®‹ã—ï¼‰${leftovers.join("ã€")}`;

    if(!resultText) {
      alert("é¸æŠã•ã‚ŒãŸé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    if (navigator.clipboard) {
        navigator.clipboard.writeText(resultText).then(() => {
            if(confirm("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã‚³ãƒ‰ãƒ¢ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰ã‚’èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ")) {
                window.open('https://parents.codmon.com/contact', '_blank');
            }
        });
    } else {
        const ta = document.createElement('textarea');
        ta.value = resultText;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        if(confirm("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã‚³ãƒ‰ãƒ¢ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰ã‚’èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ")) {
            window.open('https://parents.codmon.com/contact', '_blank');
        }
    }
  }
</script>
</body>
</html>