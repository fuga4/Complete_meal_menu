<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>é£Ÿäº‹è¨˜éŒ²</title>

<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">

<style>
  :root { --primary: #007AFF; --bg: #F2F2F7; --danger: #FF3B30; --success: #34C759; }
  
  /* ç”·ã®å­ãƒ»å¥³ã®å­ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
  body[data-user="boy"] { --theme-color: #007AFF; --theme-light: #E0F0FF; }
  body[data-user="girl"] { --theme-color: #FF2D55; --theme-light: #FFE0E6; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    background-color: var(--bg); margin: 0; padding: 0; color: #333;
    padding-bottom: 120px; transition: background 0.3s;
  }

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒƒãƒ€ãƒ¼ */
  .user-switcher {
    display: flex; gap: 10px; padding: 10px 15px; background: #fff;
    justify-content: center; border-bottom: 1px solid #eee;
  }
  .user-btn {
    flex: 1; padding: 8px; border-radius: 20px; border: 2px solid transparent;
    font-weight: bold; background: #f0f0f0; color: #999; cursor: pointer;
    font-size: 0.9rem; transition: 0.2s;
  }
  /* é¸æŠæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  body[data-user="boy"] .user-btn[data-target="boy"] {
    background: #007AFF; color: white; border-color: #0056b3;
  }
  body[data-user="girl"] .user-btn[data-target="girl"] {
    background: #FF2D55; color: white; border-color: #d6002a;
  }

  /* ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒªã‚»ãƒƒãƒˆãƒ»ã‚¿ãƒ–ï¼‰ */
  .sub-header {
    background: #fff; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .tools-bar {
    display: flex; justify-content: flex-end; padding: 5px 15px;
  }
  .btn-reset {
    font-size: 0.8rem; color: #666; background: none; border: 1px solid #ccc;
    padding: 4px 10px; border-radius: 12px; cursor: pointer;
  }

  /* é£Ÿäº‹ã‚¿ãƒ– */
  .tabs { display: flex; width: 100%; border-top: 1px solid #eee; }
  .tab-btn {
    flex: 1; padding: 12px; text-align: center; font-weight: bold; cursor: pointer;
    border-bottom: 3px solid transparent; color: #999;
  }
  .tab-btn.active {
    border-bottom-color: var(--theme-color);
    color: var(--theme-color);
    background: var(--theme-light);
  }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .container { padding: 15px; }
  .category-title {
    font-size: 0.9rem; color: #666; margin: 20px 0 8px 5px; font-weight: bold;
    display: flex; align-items: center;
  }
  .category-title::before {
    content: ''; display: inline-block; width: 4px; height: 1em;
    background: var(--theme-color); margin-right: 6px; border-radius: 2px;
  }

  .list-card {
    background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 15px;
  }
  .item-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 15px; border-bottom: 1px solid #eee;
  }
  .item-row:last-child { border-bottom: none; }
  .item-name { font-weight: 500; font-size: 1rem; }

  /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ */
  .options { display: flex; gap: 5px; }
  .radio-label {
    padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd;
    font-size: 0.8rem; cursor: pointer; background: #fff; color: #666;
    min-width: 35px; text-align: center;
  }
  input[type="radio"] { display: none; }
  
  input[value="finish"]:checked + .radio-label {
    background-color: var(--success); color: white; border-color: var(--success);
  }
  input[value="left"]:checked + .radio-label {
    background-color: var(--danger); color: white; border-color: var(--danger);
  }
  input[value="none"]:checked + .radio-label {
    background-color: #eee; color: #aaa; border-color: #eee;
  }

  /* ãã®ä»–å…¥åŠ› */
  .other-box {
    background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
  }
  .other-label { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; display: block; }
  .other-input {
    width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 1rem; box-sizing: border-box; -webkit-appearance: none;
  }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .fixed-footer {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    padding: 15px 20px; box-sizing: border-box; border-top: 1px solid #ccc;
    z-index: 200;
  }
  .btn-copy {
    width: 100%; border: none; padding: 14px; border-radius: 12px;
    font-size: 1.1rem; font-weight: bold; cursor: pointer;
    background-color: var(--theme-color); color: white;
    transition: background 0.3s;
  }
</style>
</head>
<body data-user="boy">

<div class="user-switcher">
  <button class="user-btn" data-target="boy" onclick="switchUser('boy')">ğŸ‘¦ ç”·ã®å­</button>
  <button class="user-btn" data-target="girl" onclick="switchUser('girl')">ğŸ‘§ å¥³ã®å­</button>
</div>

<div class="sub-header">
  <div class="tools-bar">
    <button class="btn-reset" onclick="resetCurrentData()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <div class="tabs">
    <div class="tab-btn active" id="tab-morning" onclick="switchMeal('morning')">â˜€ï¸ æœé£Ÿ</div>
    <div class="tab-btn" id="tab-dinner" onclick="switchMeal('dinner')">ğŸŒ™ å¤•é£Ÿ</div>
  </div>
</div>

<div class="container" id="list-container">
  <div style="text-align:center; margin-top:50px; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div class="container others-area">
  <div class="other-box">
    <label class="other-label">ãã®ä»–ï¼ˆå®Œé£Ÿï¼‰</label>
    <input type="text" id="other-finish" class="other-input" placeholder="ä¾‹ï¼šãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ" oninput="saveData()">
  </div>
  <div class="other-box">
    <label class="other-label" style="color: var(--danger);">ãã®ä»–ï¼ˆæ®‹ã—ï¼‰</label>
    <input type="text" id="other-left" class="other-input" placeholder="ä¾‹ï¼šé‡èœ" oninput="saveData()">
  </div>
</div>

<div class="fixed-footer">
  <button class="btn-copy" onclick="generateAndCopy()">ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ</button>
</div>

<script>
  // ã‚«ãƒ†ã‚´ãƒªå®šç¾© (CSVã®2åˆ—ç›®ã«å¯¾å¿œ)
  const CATEGORY_MAP = {
    1: "ä¸»é£Ÿ",
    2: "ä¸»èœ",
    3: "å‰¯èœ",
    4: "æ±ç‰©",
    5: "ãƒ‡ã‚¶ãƒ¼ãƒˆ"
  };

  // çŠ¶æ…‹ç®¡ç†
  let currentUser = 'boy';   // boy or girl
  let currentMeal = 'morning'; // morning or dinner
  let menuData = { morning: {}, dinner: {} }; // CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿

  // åˆæœŸåŒ–å‡¦ç†
  window.onload = async function() {
    // æœ€å¾Œã«ä½¿ã£ã¦ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
    const lastUser = localStorage.getItem('fc_last_user');
    const lastMeal = localStorage.getItem('fc_last_meal');
    if(lastUser) currentUser = lastUser;
    if(lastMeal) currentMeal = lastMeal;

    // UIã«åæ˜ 
    updateTheme();
    
    // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
    await loadMenuCsv();
  };

  // CSVèª­ã¿è¾¼ã¿å‡¦ç†
  async function loadMenuCsv() {
    try {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ä¸
      const response = await fetch('menu.csv?' + new Date().getTime());
      if (!response.ok) throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      
      const text = await response.text();
      parseCsv(text);
      renderPage();
      
    } catch (e) {
      document.getElementById('list-container').innerHTML = 
        `<div style="color:red; text-align:center; margin-top:20px;">
           ã‚¨ãƒ©ãƒ¼ï¼šmenu.csvã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚<br>
           åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«menu.csvãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
           (PCã§ç›´æ¥é–‹ãã¨å‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™)
         </div>`;
    }
  }

  // CSVè§£æå‡¦ç†
  function parseCsv(text) {
    const lines = text.split(/\r\n|\n/);
    
    // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    menuData = { morning: {}, dinner: {} };
    Object.values(CATEGORY_MAP).forEach(cat => {
        menuData.morning[cat] = [];
        menuData.dinner[cat] = [];
    });

    lines.forEach(line => {
      const parts = line.split(',');
      if (parts.length < 3) return; // ä¸æ­£ãªè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—

      const mealType = parts[0].trim(); // 1=æœ, 2=å¤•
      const catType = parts[1].trim();  // 1~5
      const itemName = parts[2].trim();

      const categoryName = CATEGORY_MAP[catType];
      if (!categoryName) return;

      if (mealType === '1') {
        menuData.morning[categoryName].push(itemName);
      } else if (mealType === '2') {
        menuData.dinner[categoryName].push(itemName);
      }
    });
  }

  // ç”»é¢æç”»
  function renderPage() {
    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${currentMeal}`).classList.add('active');

    // ãƒªã‚¹ãƒˆç”Ÿæˆ
    const container = document.getElementById('list-container');
    container.innerHTML = '';
    
    // ç¾åœ¨ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (ã‚­ãƒ¼: fc_data_boy_morning ç­‰)
    const savedData = getSavedData();

    // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«è¡¨ç¤º
    Object.keys(menuData[currentMeal]).forEach(cat => {
      const items = menuData[currentMeal][cat];
      if (items.length === 0) return;

      // è¦‹å‡ºã—
      const title = document.createElement('div');
      title.className = 'category-title';
      title.textContent = cat;
      container.appendChild(title);

      // ã‚«ãƒ¼ãƒ‰
      const card = document.createElement('div');
      card.className = 'list-card';

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item-row';
        
        const savedVal = savedData.checks[item] || 'none';
        const radioName = `radio_${item}`; // ä¸€æ„ãªåå‰

        row.innerHTML = `
          <div class="item-name">${item}</div>
          <div class="options">
            <label><input type="radio" name="${radioName}" value="finish" 
              ${savedVal === 'finish' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">å®Œé£Ÿ</span></label>
            <label><input type="radio" name="${radioName}" value="left" 
              ${savedVal === 'left' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">æ®‹ã—</span></label>
            <label><input type="radio" name="${radioName}" value="none" 
              ${savedVal === 'none' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">â€•</span></label>
          </div>
        `;
        card.appendChild(row);
      });
      container.appendChild(card);
    });

    // ãã®ä»–æ¬„ã®å¾©å…ƒ
    document.getElementById('other-finish').value = savedData.otherFinish || '';
    document.getElementById('other-left').value = savedData.otherLeft || '';
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
  function switchUser(user) {
    currentUser = user;
    localStorage.setItem('fc_last_user', user);
    updateTheme();
    renderPage(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç›´ã—
  }

  // é£Ÿäº‹åˆ‡ã‚Šæ›¿ãˆ
  function switchMeal(meal) {
    currentMeal = meal;
    localStorage.setItem('fc_last_meal', meal);
    renderPage();
  }

  // ãƒ†ãƒ¼ãƒæ›´æ–°
  function updateTheme() {
    document.body.setAttribute('data-user', currentUser);
  }

  // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
  function saveData() {
    const data = {
      checks: {},
      otherFinish: document.getElementById('other-finish').value,
      otherLeft: document.getElementById('other-left').value
    };

    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
      const itemName = input.name.replace('radio_', '');
      data.checks[itemName] = input.value;
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼Ã—é£Ÿäº‹ã”ã¨ã®ã‚­ãƒ¼ã§ä¿å­˜
    const key = `fc_data_${currentUser}_${currentMeal}`;
    localStorage.setItem(key, JSON.stringify(data));
  }

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  function getSavedData() {
    const key = `fc_data_${currentUser}_${currentMeal}`;
    const json = localStorage.getItem(key);
    return json ? JSON.parse(json) : { checks: {}, otherFinish: '', otherLeft: '' };
  }

  // ãƒªã‚»ãƒƒãƒˆ
  function resetCurrentData() {
    const userName = currentUser === 'boy' ? 'ç”·ã®å­' : 'å¥³ã®å­';
    const mealName = currentMeal === 'morning' ? 'æœé£Ÿ' : 'å¤•é£Ÿ';
    
    if(!confirm(`${userName}ã®${mealName}ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    
    const key = `fc_data_${currentUser}_${currentMeal}`;
    localStorage.removeItem(key);
    renderPage();
  }

  // ã‚³ãƒ”ãƒ¼ç”Ÿæˆ
  function generateAndCopy() {
    let finished = [];
    let leftovers = [];

    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é›†è¨ˆ
    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
      const itemName = input.name.replace('radio_', '');
      if (input.value === 'finish') finished.push(itemName);
      if (input.value === 'left') leftovers.push(itemName);
    });

    // ãã®ä»–é›†è¨ˆ
    const otherF = document.getElementById('other-finish').value.trim();
    const otherL = document.getElementById('other-left').value.trim();
    if(otherF) finished.push(otherF);
    if(otherL) leftovers.push(otherL);

    // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    const userName = currentUser === 'boy' ? 'ã€ç”·ã®å­ã€‘' : 'ã€å¥³ã®å­ã€‘';
    let resultText = "";
    
    // â˜…ãƒã‚¤ãƒ³ãƒˆï¼šã‚³ãƒ”ãƒ¼æ™‚ã«èª°ã®ãƒ‡ãƒ¼ã‚¿ã‹åˆ†ã‹ã‚‹ã‚ˆã†ã«åå‰ã‚’å…¥ã‚Œã‚‹ã‹ã€
    // å¿…è¦ãªã‘ã‚Œã° userName å¤‰æ•°ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
    // resultText += `${userName} \n`; 

    if(finished.length > 0) resultText += `ï¼ˆå®Œé£Ÿï¼‰${finished.join("ã€")}\n`;
    if(leftovers.length > 0) resultText += `ï¼ˆæ®‹ã—ï¼‰${leftovers.join("ã€")}`;

    if(!resultText || resultText === `${userName} \n`) {
      alert("é¸æŠã•ã‚ŒãŸé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    if (navigator.clipboard) {
        navigator.clipboard.writeText(resultText).then(() => {
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n" + resultText);
        });
    } else {
        const ta = document.createElement('textarea');
        ta.value = resultText;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n" + resultText);
    }
  }
</script>
</body>
</html>
