<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default-translucent">
<title>食事記録</title>

<link rel="icon" href="icon.jpg">
<link rel="apple-touch-icon" href="icon.jpg">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<link rel="stylesheet" href="style.css?v=5">

</head>
<body data-user="boy" data-theme="minimal">

<div id="toast" class="toast"></div>

<div id="weather-sticky-badge" class="weather-badge" style="display:none;" 
     onclick="window.open('https://weathernews.jp/onebox/35.72301407452235/139.61712889160367/', '_blank')">
  <span class="material-symbols-rounded" id="badge-icon">sunny</span>
  <span class="badge-temp" id="badge-temp">--℃</span>
</div>

<div id="weather-animation-container"></div>

<div id="weather-bar" class="weather-bar" style="display:none;">
  <span id="weather-date-label"></span>
  <span class="material-symbols-rounded" id="weather-icon">help</span>
  <span id="weather-text"></span>
  <span style="margin-left:10px; color:var(--accent); display:flex; align-items:center;">
    <span class="material-symbols-rounded" style="font-size:1rem;">umbrella</span>
    <span id="weather-pop"></span>%
  </span>
  <span style="margin-left:10px;">
    <span style="color:var(--color-danger);" id="temp-max">--</span>℃ / 
    <span style="color:var(--color-boy);" id="temp-min">--</span>℃
  </span>
</div>

<div class="sticky-header-group">
  <div class="top-row">
    <button class="user-btn" data-target="boy" onclick="switchUser('boy')">
      <span class="material-symbols-rounded">bedtime</span> 男の子
    </button>
    <button class="user-btn" data-target="girl" onclick="switchUser('girl')">
      <span class="material-symbols-rounded">music_note</span> 女の子
    </button>
    <button id="btn-partner-copy" class="btn-tool btn-partner-copy" onclick="copyToPartner()">
      <span class="material-symbols-rounded">content_copy</span> コピー
    </button>
    <button class="btn-tool" onclick="showResetModal()">
      <span class="material-symbols-rounded">restart_alt</span> リセット
    </button>
  </div>

  <div class="tabs">
    <div class="tab-btn active" id="tab-morning" onclick="switchMeal('morning')">
      <span class="material-symbols-rounded">wb_twilight</span> 朝食
    </div>
    <div class="tab-btn" id="tab-dinner" onclick="switchMeal('dinner')">
      <span class="material-symbols-rounded">restaurant</span> 夕食
    </div>
  </div>

  <div id="status-bar" class="status-bar">
    <span class="material-symbols-rounded" id="status-icon">history</span>
    <span id="status-text">確認中...</span>
  </div>
</div>

<div class="container" id="list-container">
  <div style="text-align:center; margin-top:50px; color:var(--text-sub);">読み込み中...</div>
</div>

<div class="container others-area">
  <div class="other-box">
    <label class="other-label">その他（完食）</label>
    <input type="text" id="other-finish" class="other-input" placeholder="例：ヨーグルト" onchange="saveData()">
  </div>
  <div class="other-box">
    <label class="other-label" style="color: var(--color-danger);">その他（残し）</label>
    <input type="text" id="other-left" class="other-input" placeholder="例：野菜" onchange="saveData()">
  </div>
</div>

<div class="chart-container" onclick="showNutritionHelp()">
  <div class="chart-title">栄養バランス（完食分）</div>
  <div style="flex:1; width:100%; position:relative;">
    <canvas id="nutritionChart"></canvas>
  </div>
</div>

<div class="score-area">
  <div class="score-label">栄養スコア</div>
  <div class="score-value" id="score-text">0 <span style="font-size:1.2rem;">pt</span></div>
  <div class="score-comment" id="score-comment">データなし</div>
</div>

<div class="calc-area">
  <div class="calc-header">
      <span class="calc-title">
        <span class="material-symbols-rounded">shopping_cart</span> どっちがお得？計算機
      </span>
      <button class="calc-reset-btn" onclick="clearCalc()">クリア</button>
  </div>
  <table class="calc-table">
      <thead>
          <tr>
              <th style="font-size:0.75rem; color:var(--text-sub);">量 (g/個)</th>
              <th style="font-size:0.75rem; color:var(--text-sub);">価格 (円)</th>
              <th style="font-size:0.75rem; color:var(--text-sub);">単価</th>
          </tr>
      </thead>
      <tbody id="calc-body">
          </tbody>
  </table>
</div>

<div class="theme-switcher-area">
  <div class="theme-title">
    <span class="material-symbols-rounded">palette</span> デザイン切替
  </div>
  <div class="theme-btn-group">
    <button class="theme-btn active" id="theme-btn-minimal" onclick="switchTheme('minimal')">Minimal</button>
    <button class="theme-btn" id="theme-btn-glass" onclick="switchTheme('glass')">Glass</button>
    <button class="theme-btn" id="theme-btn-clay" onclick="switchTheme('clay')">Clay</button>
  </div>
</div>

<div class="fixed-footer">
  <div class="footer-btn-group">
    <button class="btn-copy btn-copy-sub" onclick="generateAndCopy(false)">
      コピーのみ
    </button>
    <button class="btn-copy btn-copy-main" onclick="generateAndCopy(true)">
      コピー＆起動
    </button>
  </div>
</div>

<div id="reset-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">リセットメニュー</div>
    <div class="modal-btn-group">
      <button class="modal-btn btn-reset-one" onclick="resetCurrent()">表示中の食事のみリセット</button>
      <button class="modal-btn btn-reset-all" onclick="resetAll()">全データをリセット<br><span style="font-size:0.8rem">(全員・全食)</span></button>
      <button class="modal-btn btn-cancel" onclick="closeModal()">キャンセル</button>
    </div>
  </div>
</div>

<div id="nutrition-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">栄養素のヒミツ</div>
    <div class="nutrition-list">
      <div class="nutrition-item">
        <span class="nut-label" style="color:#FF9500">
          <span class="material-symbols-rounded icon-yellow">bolt</span> 黄（エネルギー）
        </span>
        <span class="nut-desc">炭水化物、油、砂糖<br>（パン、ご飯、ポテト、甘栗など）</span>
      </div>
      <div class="nutrition-item">
        <span class="nut-label" style="color:#FF3B30">
          <span class="material-symbols-rounded icon-red">fitness_center</span> 赤（からだを作る）
        </span>
        <span class="nut-desc">タンパク質、カルシウム<br>（肉、魚、卵、牛乳、豆、チーズ）</span>
      </div>
      <div class="nutrition-item">
        <span class="nut-label" style="color:#34C759">
          <span class="material-symbols-rounded icon-green">spa</span> 緑（調子を整える）
        </span>
        <span class="nut-desc">ビタミン、ミネラル、食物繊維<br>（野菜、果物）</span>
      </div>
    </div>
    <div class="modal-btn-group">
      <button class="modal-btn btn-cancel" onclick="closeNutritionModal()">閉じる</button>
    </div>
  </div>
</div>

<script src="script.js?v=5"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { firebaseConfig } from "./config.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  // ★重要：グローバル変数への割り当て
  window.db = db;
  window.set = set;
  window.ref = ref;
  window.onValue = onValue;
  window.get = get;

  const auth = getAuth(app);
  signInAnonymously(auth).then(() => {
      console.log("Logged in anonymously");
      // script.jsの読み込みとFirebaseの接続が完了してからinitAppを呼ぶ
      const checkInit = setInterval(() => {
          if (typeof window.initApp === 'function') {
              clearInterval(checkInit);
              window.initApp();
          }
      }, 100);
  }).catch((error) => {
      console.error("Login failed", error);
      alert(`エラーが発生しました\nCode: ${error.code}\nMessage: ${error.message}`);
  });
</script>

</body>
</html>
