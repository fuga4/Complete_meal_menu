<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default-translucent">
<title>é£Ÿäº‹è¨˜éŒ²</title>

<link rel="icon" href="icon.jpg">
<link rel="apple-touch-icon" href="icon.jpg">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* --- å…±é€šå¤‰æ•°å®šç¾© --- */
  :root {
    --transition-speed: 0.3s;
    
    /* â˜…å¤‰æ›´ï¼šãƒ¢ãƒ€ãƒ³ã‚°ãƒ¬ã‚¤ãƒƒã‚·ãƒ¥ï¼ˆãã™ã¿ï¼‰ã‚«ãƒ©ãƒ¼å®šç¾© */
    --color-boy: #6086B0;   /* ã‚°ãƒ¬ã‚¤ãƒƒã‚·ãƒ¥ãƒ–ãƒ«ãƒ¼ */
    --color-girl: #C07B8E;  /* ãƒ€ã‚¹ãƒ†ã‚£ãƒ”ãƒ³ã‚¯ */
    
    --color-success: #699B7E; /* ã‚»ãƒ¼ã‚¸ã‚°ãƒªãƒ¼ãƒ³ï¼ˆå®Œé£Ÿï¼‰ */
    --color-danger: #C26D6D;  /* ãƒŸãƒ¥ãƒ¼ãƒˆãƒ¬ãƒƒãƒ‰ï¼ˆæ®‹ã—ï¼‰ */
    --color-neutral: #E0E0E0; /* ã‚°ãƒ¬ãƒ¼ï¼ˆæœªé¸æŠï¼‰ */
    
    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --letter-spacing: 0.03em; 
  }

  /* 1. Minimal (ãƒŸãƒ‹ãƒãƒ«) */
  body[data-theme="minimal"] {
    --bg-body: #F9F9FB;
    --bg-card: #FFFFFF;
    --bg-header: rgba(255, 255, 255, 0.98);
    --text-main: #333333;
    --text-sub: #8E8E93;
    --border-color: #E5E5EA;
    
    --shadow-card: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-btn: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-float: 0 4px 12px rgba(0,0,0,0.08);
    
    --radius-card: 8px;
    --radius-btn: 6px;
    --btn-bg-off: #F2F2F7;
    --btn-text-off: #8E8E93;
    
    --backdrop: saturate(180%) blur(20px);
    --border-width: 1px;
  }

  /* 2. Glass (ã‚°ãƒ©ã‚¹) */
  body[data-theme="glass"] {
    /* èƒŒæ™¯ã‚’å°‘ã—æ¿ƒã„ã‚ã«ã—ã¦ç™½æ–‡å­—ã‚’è¦‹ã‚„ã™ã */
    --bg-body: linear-gradient(135deg, #E3E9F2 0%, #E8E4F0 100%);
    --bg-card: rgba(255, 255, 255, 0.65);
    --bg-header: rgba(255, 255, 255, 0.75);
    --text-main: #3A3A3C;
    --text-sub: #7C7C82;
    --border-color: rgba(255, 255, 255, 0.8);
    
    --shadow-card: 
      0 4px 24px -1px rgba(0, 0, 0, 0.05),
      inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    --shadow-btn: 0 2px 8px rgba(0,0,0,0.03), inset 0 0 0 1px rgba(255,255,255,0.4);
    --shadow-float: 0 8px 32px rgba(0,0,0,0.12);
    
    --radius-card: 12px;
    --radius-btn: 10px;
    --btn-bg-off: rgba(255, 255, 255, 0.5);
    --btn-text-off: #7C7C82;
    
    --backdrop: blur(16px) saturate(150%);
    --border-width: 0px;
  }

  /* 3. Clay (ã‚¯ãƒ¬ã‚¤) */
  body[data-theme="clay"] {
    --bg-body: #EEF1F5;
    --bg-card: #EEF1F5;
    --bg-header: rgba(238, 241, 245, 0.95);
    --text-main: #4A5568;
    --text-sub: #A0AEC0;
    --border-color: transparent;
    
    --shadow-card: 8px 8px 16px #D9E2EC, -8px -8px 16px #FFFFFF;
    --shadow-btn: 4px 4px 8px #D9E2EC, -4px -4px 8px #FFFFFF;
    --shadow-btn-active: inset 4px 4px 8px #D9E2EC, inset -4px -4px 8px #FFFFFF;
    --shadow-float: 12px 12px 24px #D9E2EC;

    --radius-card: 16px;
    --radius-btn: 10px;
    --btn-bg-off: #EEF1F5;
    --btn-text-off: #A0AEC0;
    
    --backdrop: none;
    --border-width: 0px;
  }

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ©ãƒ¼é©ç”¨ */
  body[data-user="boy"] { --accent: var(--color-boy); --accent-light: #F0F4F8; }
  body[data-user="girl"] { --accent: var(--color-girl); --accent-light: #F9F0F2; }

  /* Glassãƒ†ãƒ¼ãƒæ™‚ã®è¦–èªæ€§èª¿æ•´ */
  body[data-theme="glass"][data-user="boy"] { --accent: #5076A0; } /* å°‘ã—æ¿ƒãã™ã‚‹ */

  /* å¤©æ°—èƒŒæ™¯ã®ä¸Šæ›¸ã (Glassãƒ†ãƒ¼ãƒä»¥å¤–) */
  body:not([data-theme="glass"]).weather-sunny { background-color: #EBF7FF !important; }
  body:not([data-theme="glass"]).weather-cloudy { background-color: #E0E5EC !important; }

  /* --- ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
  body {
    font-family: var(--font-family);
    letter-spacing: var(--letter-spacing);
    background: var(--bg-body); 
    background-attachment: fixed;
    margin: 0; padding: 0; color: var(--text-main);
    padding-bottom: 220px; 
    transition: all var(--transition-speed) ease;
    position: relative;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* çµµæ–‡å­—ãƒˆãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ */
  .emoji-toned { filter: grayscale(0.2) opacity(0.85); display: inline-block; }

  #weather-animation-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: -1; overflow: hidden;
  }
  .rain-drop {
      position: absolute; width: 3px; height: 20px; 
      background: rgba(96, 134, 176, 0.6); bottom: 100%; /* é›¨ã‚‚ã‚°ãƒ¬ã‚¤ãƒƒã‚·ãƒ¥ãƒ–ãƒ«ãƒ¼ã« */
      animation: fall linear infinite;
  }
  .snow-flake {
      position: absolute; width: 12px; height: 12px; 
      background: rgba(255,255,255,0.9); border-radius: 50%;
      box-shadow: 0 0 4px rgba(255,255,255,0.8); bottom: 100%;
      animation: fall linear infinite;
  }
  @keyframes fall { to { transform: translateY(110vh); } }

  .weather-bar {
    background: var(--bg-header);
    backdrop-filter: var(--backdrop);
    padding: 8px 15px; font-size: 0.8rem; color: var(--text-sub);
    display: flex; justify-content: center; align-items: center; gap: 10px;
    border-bottom: var(--border-width) solid var(--border-color); font-weight: 600;
    min-height: 28px;
    transition: all var(--transition-speed);
  }

  .sticky-header-group {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg-header);
    backdrop-filter: var(--backdrop);
    box-shadow: var(--shadow-card);
    transition: all var(--transition-speed);
    border-bottom: 1px solid rgba(0,0,0,0.03);
  }

  .top-row {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 15px; 
    border-bottom: var(--border-width) solid var(--border-color);
  }

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
  .user-btn {
    flex: 2; padding: 10px 4px;
    border-radius: var(--radius-btn); 
    border: var(--border-width) solid var(--border-color);
    font-weight: 600; 
    background: var(--btn-bg-off); 
    color: var(--btn-text-off); 
    box-shadow: var(--shadow-btn);
    cursor: pointer; font-size: 0.85rem; 
    transition: all 0.2s ease;
    touch-action: manipulation; white-space: nowrap; text-align: center;
    display: flex; justify-content: center; align-items: center; gap: 4px;
  }
  
  /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ï¼šè‰²ã¯CSSå¤‰æ•°(--accent)ã§åˆ¶å¾¡ */
  body[data-user="boy"] .user-btn[data-target="boy"],
  body[data-user="girl"] .user-btn[data-target="girl"] { 
    background: var(--accent); color: white; border-color: transparent;
    box-shadow: 0 2px 8px rgba(0,0,0, 0.15); /* å½±ã‚’ã‚°ãƒ¬ãƒ¼ã«ã—ã¦é¦´æŸ“ã¾ã›ã‚‹ */
  }
  
  /* Glassãƒ†ãƒ¼ãƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–èª¿æ•´ */
  body[data-theme="glass"][data-user="boy"] .user-btn[data-target="boy"],
  body[data-theme="glass"][data-user="girl"] .user-btn[data-target="girl"] {
      opacity: 1;
      background: var(--accent); /* é€æ˜åº¦ã‚’ãªãã—ã¦è¦–èªæ€§ç¢ºä¿ */
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  /* Clayãƒ†ãƒ¼ãƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ */
  body[data-theme="clay"][data-user="boy"] .user-btn[data-target="boy"],
  body[data-theme="clay"][data-user="girl"] .user-btn[data-target="girl"] {
    background: var(--btn-bg-off); color: var(--accent);
    box-shadow: var(--shadow-btn-active);
  }

  /* ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
  .btn-tool {
    flex: 1; font-size: 0.75rem; 
    background: var(--bg-card); 
    border: var(--border-width) solid var(--border-color);
    padding: 0 8px; border-radius: var(--radius-btn); cursor: pointer; color: var(--text-sub);
    box-shadow: var(--shadow-btn);
    white-space: nowrap; text-align: center;
    display: flex; justify-content: center; align-items: center;
    height: 38px; box-sizing: border-box; font-weight: 600;
    transition: all 0.2s;
  }
  .btn-tool:active { transform: scale(0.98); }
  .btn-partner-copy { color: var(--accent); }
  body[data-theme="glass"] .btn-partner-copy { background: rgba(255,255,255,0.7); }

  .tabs { display: flex; width: 100%; }
  .tab-btn {
    flex: 1; padding: 12px; text-align: center; font-weight: 600; cursor: pointer;
    border-bottom: 2px solid transparent; color: var(--text-sub); font-size: 0.85rem;
    transition: all 0.3s;
    display: flex; justify-content: center; align-items: center; gap: 4px;
  }
  .tab-btn.active {
    border-bottom-color: var(--accent); color: var(--accent); 
  }
  body:not([data-theme="minimal"]) .tab-btn.active {
      background: linear-gradient(to bottom, transparent, var(--accent-light));
  }

  .container { padding: 18px; }
  .category-title {
    font-size: 0.85rem; color: var(--text-sub); margin: 24px 0 12px 2px; font-weight: 700;
    display: flex; align-items: center; text-transform: uppercase; letter-spacing: 0.05em;
  }
  .category-title::before {
    content: ''; display: inline-block; width: 3px; height: 14px;
    background: var(--accent); margin-right: 8px; border-radius: 2px;
    opacity: 0.8;
  }

  /* ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
  .list-card {
    background: var(--bg-card); 
    border-radius: var(--radius-card); 
    box-shadow: var(--shadow-card);
    margin-bottom: 18px; overflow: hidden;
    transition: all var(--transition-speed);
    backdrop-filter: var(--backdrop); 
    border: var(--border-width) solid var(--border-color);
  }
  
  /* â˜…ä¿®æ­£ï¼šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ */
  .item-row {
    display: flex; 
    align-items: center; 
    justify-content: space-between; /* å·¦å³é…ç½® */
    gap: 8px; /* è¦ç´ é–“ã®éš™é–“ */
    padding: 15px 18px; 
    border-bottom: 1px solid rgba(0,0,0,0.03);
  }
  .item-row:last-child { border-bottom: none; }
  
  .item-name { 
    font-weight: 600; font-size: 0.95rem; color: var(--text-main); 
    flex: 1; /* ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨éƒ¨ä½¿ã† */
    min-width: 0; /* æ–‡å­—ãŒé•·ãã¦ã‚‚ç¸®ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹ãƒªã‚»ãƒƒãƒˆ */
    word-break: break-all; /* é•·ã™ãã‚‹å˜èªã¯æŠ˜ã‚Šè¿”ã™ */
    line-height: 1.4;
  }

  .options { 
    flex-shrink: 0; /* çµ¶å¯¾ã«ç¸®ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    display: flex; 
    gap: 6px; 
  }

  .radio-label {
    padding: 8px 0; /* æ¨ªå¹…ã¯widthã§æŒ‡å®šã™ã‚‹ãŸã‚paddingæ¨ªã¯0 */
    width: 48px;    /* å¹…ã‚’å›ºå®šã—ã¦æ–‡å­—å´©ã‚Œã‚’é˜²ã */
    border-radius: 6px;
    border: 1px solid transparent;
    font-size: 0.75rem; 
    cursor: pointer; background: var(--btn-bg-off); 
    color: var(--btn-text-off); 
    text-align: center;
    transition: all 0.2s; font-weight: 600; box-shadow: var(--shadow-btn);
    white-space: nowrap; /* æ–‡å­—ã®æŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
    display: flex; justify-content: center; align-items: center;
  }
  body[data-theme="minimal"] .radio-label { border-color: var(--border-color); background: #fff; box-shadow: none; }

  input[type="radio"] { display: none; }
  
  /* â˜…å¤‰æ›´ï¼šã‚°ãƒ¬ã‚¤ãƒƒã‚·ãƒ¥ã‚«ãƒ©ãƒ¼é©ç”¨ */
  input[value="finish"]:checked + .radio-label { 
    background-color: var(--color-success); color: white; border-color: transparent; 
    box-shadow: 0 2px 8px rgba(105, 155, 126, 0.4);
  }
  input[value="left"]:checked + .radio-label { 
    background-color: var(--color-danger); color: white; border-color: transparent;
    box-shadow: 0 2px 8px rgba(194, 109, 109, 0.4);
  }
  input[value="none"]:checked + .radio-label { 
    background-color: var(--color-neutral); color: #999; box-shadow: none;
  }
  body[data-theme="clay"] input:checked + .radio-label {
    transform: scale(0.97); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
  }

  .other-box { 
    background: var(--bg-card); padding: 18px; border-radius: var(--radius-card); 
    margin-bottom: 12px; box-shadow: var(--shadow-card);
    backdrop-filter: var(--backdrop); border: var(--border-width) solid var(--border-color);
  }
  .other-label { font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; display: block; color: var(--text-main); }
  .other-input {
    width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;
    font-size: 0.95rem; box-sizing: border-box; -webkit-appearance: none;
    background: rgba(255,255,255,0.3); color: var(--text-main); transition: 0.2s;
    font-family: inherit;
  }
  .other-input:focus { outline: none; border-color: var(--accent); background: var(--bg-card); }

  .chart-container {
    margin: 15px 18px; background: var(--bg-card); border-radius: var(--radius-card);
    padding: 20px 10px; box-shadow: var(--shadow-card);
    height: 360px; position: relative;
    display: flex; flex-direction: column; align-items: center;
    backdrop-filter: var(--backdrop); border: var(--border-width) solid var(--border-color);
  }
  .chart-title { 
    text-align: center; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 10px; 
    font-weight: 700; width:100%; display: flex; justify-content: center; align-items: center; gap:6px;
  }
  .chart-title::after {
    content: '?'; display: inline-block; width: 16px; height: 16px; 
    background: var(--text-sub); color: var(--bg-card); border-radius: 50%; 
    font-size: 11px; line-height: 16px; text-align: center; opacity: 0.7;
  }

  .score-area {
    margin: 0 18px 20px 18px; background: var(--bg-card); border-radius: var(--radius-card);
    padding: 25px; text-align: center; box-shadow: var(--shadow-float);
    backdrop-filter: var(--backdrop);
    position: relative; overflow: hidden;
    border: var(--border-width) solid var(--border-color);
  }
  body[data-theme="minimal"] .score-area { border: 2px solid var(--accent); box-shadow: none; }

  body[data-theme="glass"] .score-area::before {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(to bottom right, rgba(255,255,255,0.4), transparent);
    transform: rotate(45deg); pointer-events: none;
  }
  .score-label { font-size: 0.85rem; color: var(--text-sub); font-weight: 700; letter-spacing: 0.05em; }
  .score-value { 
    font-size: 3rem; font-weight: 800; color: var(--accent); line-height: 1.1; 
    margin: 5px 0;
  }
  .score-comment { font-size: 1rem; color: var(--text-main); margin-top: 8px; font-weight: 700; }

  .calc-area {
    margin: 35px 18px 20px 18px; background: var(--bg-card); border-radius: var(--radius-card);
    padding: 20px; box-shadow: var(--shadow-card);
    backdrop-filter: var(--backdrop); border: var(--border-width) solid var(--border-color);
  }
  .calc-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px;
  }
  .calc-title { font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
  .calc-reset-btn {
      font-size: 0.75rem; color: var(--text-sub); background: var(--btn-bg-off); border: var(--border-width) solid var(--border-color);
      padding: 4px 10px; border-radius: 6px; cursor: pointer; font-weight: 600;
  }
  .calc-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
  .calc-row td { padding: 0 4px; }
  .calc-input {
      width: 100%; padding: 10px; box-sizing: border-box;
      border: 1px solid var(--border-color); border-radius: 8px;
      font-size: 0.95rem; text-align: center; -webkit-appearance: none;
      background: rgba(255,255,255,0.3); color: var(--text-main); font-family: inherit;
  }
  .calc-input:focus { border-color: var(--accent); background: var(--bg-card); outline: none; }
  .calc-result { text-align: center; font-size: 0.9rem; color: var(--text-sub); font-weight: 700; }
  .calc-row.is-cheapest .calc-input { 
    border-color: var(--accent); background-color: var(--accent-light);
  }
  .calc-row.is-cheapest .calc-result { color: var(--color-danger); font-size: 1.1rem; }

  .theme-switcher-area { margin: 40px 18px 120px 18px; text-align: center; }
  .theme-title { font-size:0.8rem; color:var(--text-sub); margin-bottom:12px; font-weight:700; letter-spacing: 0.05em; display: flex; align-items: center; justify-content: center; gap: 6px; }
  .theme-btn-group {
    display: inline-flex; background: var(--bg-card); border-radius: 12px;
    padding: 4px; box-shadow: var(--shadow-card); backdrop-filter: var(--backdrop);
    border: var(--border-width) solid var(--border-color);
  }
  .theme-btn {
    padding: 8px 16px; border: none; background: transparent; cursor: pointer;
    border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-sub); transition: 0.3s;
    font-family: inherit;
  }
  .theme-btn.active {
    background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  body[data-theme="minimal"] .theme-btn.active { background: var(--text-main); color: white; box-shadow: none; }

  .fixed-footer {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: var(--bg-header); backdrop-filter: blur(20px);
    padding: 15px 20px; box-sizing: border-box; border-top: 1px solid rgba(0,0,0,0.05);
    z-index: 200; box-shadow: 0 -4px 20px rgba(0,0,0,0.04);
  }
  .btn-copy {
    width: 100%; border: none; padding: 14px; border-radius: 12px;
    font-size: 1rem; font-weight: 700; cursor: pointer;
    background-color: var(--accent); color: white; 
    transition: background 0.3s, transform 0.1s;
    box-shadow: 0 4px 12px rgba(0,0,0, 0.15);
    font-family: inherit; letter-spacing: 0.05em;
  }
  .btn-copy:active { transform: scale(0.98); }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
    z-index: 999; display: none;
    align-items: center; justify-content: center;
    animation: fadeIn 0.25s ease;
  }
  .modal-content {
    background: var(--bg-card); width: 80%; max-width: 300px; border-radius: 16px;
    padding: 24px; box-shadow: var(--shadow-float); text-align: center;
    color: var(--text-main); border: var(--border-width) solid var(--border-color);
  }
  .modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 20px; }
  .modal-btn-group { display: flex; flex-direction: column; gap: 10px; }
  .modal-btn {
    padding: 12px; border: 1px solid transparent; border-radius: 8px; font-size: 0.95rem; cursor: pointer; font-weight: 600; transition: 0.2s; font-family: inherit;
  }
  .btn-reset-one { background: var(--btn-bg-off); color: var(--text-main); border-color: var(--border-color); }
  .btn-reset-all { background: rgba(194, 109, 109, 0.1); color: var(--color-danger); }
  .btn-cancel { background: transparent; color: var(--text-sub); margin-top: 5px; }

  .nutrition-list { text-align: left; font-size: 0.9rem; line-height: 1.7; color: var(--text-main); }
  .nutrition-item { margin-bottom: 18px; }
  .nut-label { font-weight: 700; display: block; margin-bottom: 4px; font-size: 0.95rem; }
  .nut-desc { color: var(--text-sub); font-size: 0.85rem; }

  @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

</style>
</head>
<body data-user="boy" data-theme="minimal">

<div id="weather-animation-container"></div>

<div id="weather-bar" class="weather-bar" style="display:none;">
  <span id="weather-date-label"></span>
  <span class="emoji-toned weather-icon" id="weather-icon"></span>
  <span id="weather-text"></span>
  <span style="margin-left:10px; color:var(--accent); display:flex; align-items:center;">
    <span class="emoji-toned" style="font-size:0.9rem; margin-right:2px;">â˜‚ï¸</span>
    <span id="weather-pop"></span>%
  </span>
  <span style="margin-left:10px;">
    <span style="color:var(--color-danger);" id="temp-max">--</span>â„ƒ / 
    <span style="color:var(--color-boy);" id="temp-min">--</span>â„ƒ
  </span>
</div>

<div class="sticky-header-group">
  <div class="top-row">
    <button class="user-btn" data-target="boy" onclick="switchUser('boy')">
      <span class="emoji-toned">ğŸŒ™</span> ç”·ã®å­
    </button>
    <button class="user-btn" data-target="girl" onclick="switchUser('girl')">
      <span class="emoji-toned">ğŸµ</span> å¥³ã®å­
    </button>
    <button id="btn-partner-copy" class="btn-tool btn-partner-copy" onclick="copyToPartner()">
      <span class="emoji-toned">ğŸ“‹</span> ğŸµã¸ã‚³ãƒ”ãƒ¼
    </button>
    <button class="btn-tool" onclick="showResetModal()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="tabs">
    <div class="tab-btn active" id="tab-morning" onclick="switchMeal('morning')">
      <span class="emoji-toned">ğŸŒ…</span> æœé£Ÿ
    </div>
    <div class="tab-btn" id="tab-dinner" onclick="switchMeal('dinner')">
      <span class="emoji-toned">ğŸŒƒ</span> å¤•é£Ÿ
    </div>
  </div>
</div>

<div class="container" id="list-container">
  <div style="text-align:center; margin-top:50px; color:var(--text-sub);">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div class="container others-area">
  <div class="other-box">
    <label class="other-label">ãã®ä»–ï¼ˆå®Œé£Ÿï¼‰</label>
    <input type="text" id="other-finish" class="other-input" placeholder="ä¾‹ï¼šãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ" onchange="saveData()">
  </div>
  <div class="other-box">
    <label class="other-label" style="color: var(--color-danger);">ãã®ä»–ï¼ˆæ®‹ã—ï¼‰</label>
    <input type="text" id="other-left" class="other-input" placeholder="ä¾‹ï¼šé‡èœ" onchange="saveData()">
  </div>
</div>

<div class="chart-container" onclick="showNutritionHelp()">
  <div class="chart-title">æ „é¤Šãƒãƒ©ãƒ³ã‚¹ï¼ˆå®Œé£Ÿåˆ†ï¼‰</div>
  <div style="flex:1; width:100%; position:relative;">
    <canvas id="nutritionChart"></canvas>
  </div>
</div>

<div class="score-area">
  <div class="score-label">æ „é¤Šã‚¹ã‚³ã‚¢</div>
  <div class="score-value" id="score-text">0 <span style="font-size:1.2rem;">pt</span></div>
  <div class="score-comment" id="score-comment">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
</div>

<div class="calc-area">
  <div class="calc-header">
      <span class="calc-title">
        <span class="emoji-toned">ğŸ›’</span> ã©ã£ã¡ãŒãŠå¾—ï¼Ÿè¨ˆç®—æ©Ÿ
      </span>
      <button class="calc-reset-btn" onclick="clearCalc()">ã‚¯ãƒªã‚¢</button>
  </div>
  <table class="calc-table">
      <thead>
          <tr>
              <th style="font-size:0.75rem; color:var(--text-sub);">é‡ (g/å€‹)</th>
              <th style="font-size:0.75rem; color:var(--text-sub);">ä¾¡æ ¼ (å††)</th>
              <th style="font-size:0.75rem; color:var(--text-sub);">å˜ä¾¡</th>
          </tr>
      </thead>
      <tbody id="calc-body">
          </tbody>
  </table>
</div>

<div class="theme-switcher-area">
  <div class="theme-title">
    <span class="emoji-toned">ğŸ¨</span> ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡æ›¿
  </div>
  <div class="theme-btn-group">
    <button class="theme-btn active" id="theme-btn-minimal" onclick="switchTheme('minimal')">Minimal</button>
    <button class="theme-btn" id="theme-btn-glass" onclick="switchTheme('glass')">Glass</button>
    <button class="theme-btn" id="theme-btn-clay" onclick="switchTheme('clay')">Clay</button>
  </div>
</div>

<div class="fixed-footer">
  <button class="btn-copy" onclick="generateAndCopy()">ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ</button>
</div>

<div id="reset-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <div class="modal-btn-group">
      <button class="modal-btn btn-reset-one" onclick="resetCurrent()">è¡¨ç¤ºä¸­ã®é£Ÿäº‹ã®ã¿ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="modal-btn btn-reset-all" onclick="resetAll()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ<br><span style="font-size:0.8rem">(å…¨å“¡ãƒ»å…¨é£Ÿ)</span></button>
      <button class="modal-btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div id="nutrition-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">æ „é¤Šç´ ã®ãƒ’ãƒŸãƒ„</div>
    <div class="nutrition-list">
      <div class="nutrition-item">
        <span class="nut-label" style="color:#D4A056"><span class="emoji-toned">ğŸ’›</span> é»„ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰</span>
        <span class="nut-desc">ç‚­æ°´åŒ–ç‰©ã€æ²¹ã€ç ‚ç³–<br>ï¼ˆãƒ‘ãƒ³ã€ã”é£¯ã€ãƒãƒ†ãƒˆã€ç”˜æ —ãªã©ï¼‰</span>
      </div>
      <div class="nutrition-item">
        <span class="nut-label" style="color:#C26D6D"><span class="emoji-toned">â¤ï¸</span> èµ¤ï¼ˆã‹ã‚‰ã ã‚’ä½œã‚‹ï¼‰</span>
        <span class="nut-desc">ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€ã‚«ãƒ«ã‚·ã‚¦ãƒ <br>ï¼ˆè‚‰ã€é­šã€åµã€ç‰›ä¹³ã€è±†ã€ãƒãƒ¼ã‚ºï¼‰</span>
      </div>
      <div class="nutrition-item">
        <span class="nut-label" style="color:#699B7E"><span class="emoji-toned">ğŸ’š</span> ç·‘ï¼ˆèª¿å­ã‚’æ•´ãˆã‚‹ï¼‰</span>
        <span class="nut-desc">ãƒ“ã‚¿ãƒŸãƒ³ã€ãƒŸãƒãƒ©ãƒ«ã€é£Ÿç‰©ç¹Šç¶­<br>ï¼ˆé‡èœã€æœç‰©ï¼‰</span>
      </div>
    </div>
    <div class="modal-btn-group">
      <button class="modal-btn btn-cancel" onclick="closeNutritionModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { firebaseConfig } from "./config.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  const auth = getAuth(app);
  signInAnonymously(auth).then(() => {
      console.log("Logged in anonymously");
      initApp();
  }).catch((error) => {
      console.error("Login failed", error);
      alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\nCode: ${error.code}\nMessage: ${error.message}`);
  });

  window.db = db;
  window.set = set;
  window.ref = ref;
  window.onValue = onValue;
  window.get = get;
</script>

<script>
  const CATEGORY_MAP = { 1: "ä¸»é£Ÿ", 2: "ä¸»èœ", 3: "å‰¯èœ", 4: "æ±ç‰©", 5: "ãƒ‡ã‚¶ãƒ¼ãƒˆ" };
  
  let currentUser = 'boy';   
  let currentMeal = 'morning'; 
  let currentTheme = 'minimal'; 
  let menuData = { morning: {}, dinner: {} }; 
  let nutritionMap = {}; 
  let currentFirebaseData = { checks: {}, otherFinish: '', otherLeft: '' }; 
  let myChart = null;
  let weatherAnimInterval = null;
  let weatherCode = null; 

  let touchStartX = 0;
  let touchStartY = 0;

  function initApp() {
    const lastUser = localStorage.getItem('fc_last_user');
    if(lastUser) currentUser = lastUser;

    // ãƒ†ãƒ¼ãƒèª­ã¿è¾¼ã¿
    const lastTheme = localStorage.getItem('fc_theme');
    if(lastTheme) {
        if (['minimal', 'glass', 'clay'].includes(lastTheme)) {
            switchTheme(lastTheme);
        } else {
            switchTheme('minimal');
        }
    }

    const currentHour = new Date().getHours();
    if (currentHour >= 12) {
        currentMeal = 'dinner';
    } else {
        currentMeal = 'morning';
    }

    updateTheme(); 
    loadMenuCsv().then(() => {
      initChart();
      setupRealtimeListener(); 
      getWeather(); 
      initCalc();
      setupSwipeListener(); 
    });
  }

  // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
  window.switchTheme = function(themeName) {
      currentTheme = themeName;
      localStorage.setItem('fc_theme', themeName);
      
      document.body.setAttribute('data-theme', themeName);
      
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.getElementById(`theme-btn-${themeName}`);
      if(activeBtn) activeBtn.classList.add('active');

      if (weatherCode !== null) {
          applyWeatherEffect(weatherCode);
      }
      
      if(myChart) updateChartAndScore();
  }

  function setupSwipeListener() {
    document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
    }, { passive: true });
  }

  function handleSwipe(startX, startY, endX, endY) {
      const diffX = endX - startX;
      const diffY = endY - startY;
      const threshold = 50; 

      if (Math.abs(diffY) > Math.abs(diffX)) return;

      if (Math.abs(diffX) > threshold) {
          if (diffX > 0) {
              if (currentUser === 'girl') switchUser('boy');
          } else {
              if (currentUser === 'boy') switchUser('girl');
          }
      }
  }

  function initCalc() {
      const tbody = document.getElementById('calc-body');
      tbody.innerHTML = '';
      for (let i = 0; i < 4; i++) {
          const row = document.createElement('tr');
          row.className = 'calc-row';
          row.innerHTML = `
              <td><input type="number" class="calc-input qty" placeholder="0" oninput="updateCalc()"></td>
              <td><input type="number" class="calc-input price" placeholder="0" oninput="updateCalc()"></td>
              <td class="calc-result">-</td>
          `;
          tbody.appendChild(row);
      }
  }

  window.updateCalc = function() {
      const rows = document.querySelectorAll('.calc-row');
      let minUnit = Infinity;
      let validRows = [];

      rows.forEach(row => {
          const qty = parseFloat(row.querySelector('.qty').value);
          const price = parseFloat(row.querySelector('.price').value);
          const resEl = row.querySelector('.calc-result');
          
          row.classList.remove('is-cheapest'); 

          if (qty > 0 && price > 0) {
              const unitPrice = price / qty;
              resEl.textContent = unitPrice.toFixed(2);
              validRows.push({ row, unitPrice });
              if (unitPrice < minUnit) minUnit = unitPrice;
          } else {
              resEl.textContent = '-';
          }
      });

      if (validRows.length >= 2) {
          validRows.forEach(item => {
              if (item.unitPrice === minUnit) {
                  item.row.classList.add('is-cheapest');
                  item.row.querySelector('.calc-result').innerHTML = `ğŸ† ${item.unitPrice.toFixed(2)}`;
              }
          });
      }
  };

  window.clearCalc = function() {
      const inputs = document.querySelectorAll('.calc-input');
      inputs.forEach(input => input.value = '');
      window.updateCalc();
  };

  async function getWeather() {
    try {
      const url = "https://api.open-meteo.com/v1/forecast?latitude=35.6995&longitude=139.6355&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo";
      
      const res = await fetch(url);
      const data = await res.json();

      if (!data || !data.daily) throw new Error("No data");

      const currentHour = new Date().getHours();
      const isPm = currentHour >= 12;
      
      const targetIndex = isPm ? 1 : 0;
      const targetLabel = isPm ? "æ˜æ—¥" : "ä»Šæ—¥";

      const daily = data.daily;
      weatherCode = daily.weathercode[targetIndex]; 
      const weatherText = getWmoWeatherText(weatherCode);
      const weatherIcon = getWmoWeatherIcon(weatherCode);
      const maxTemp = daily.temperature_2m_max[targetIndex];
      const minTemp = daily.temperature_2m_min[targetIndex];
      const pop = daily.precipitation_probability_max[targetIndex];

      document.getElementById('weather-date-label').textContent = targetLabel + "ï¼š";
      document.getElementById('weather-icon').textContent = weatherIcon;
      document.getElementById('weather-text').textContent = weatherText;
      document.getElementById('weather-pop').textContent = (pop !== null) ? pop : "--";
      document.getElementById('temp-min').textContent = (minTemp !== null) ? Math.round(minTemp) : "--";
      document.getElementById('temp-max').textContent = (maxTemp !== null) ? Math.round(maxTemp) : "--";
      
      document.getElementById('weather-bar').style.display = 'flex';

      applyWeatherEffect(weatherCode);

    } catch (e) {
      console.log("Weather error: ", e);
    }
  }

  function applyWeatherEffect(code) {
      const body = document.body;
      const container = document.getElementById('weather-animation-container');
      
      body.classList.remove('weather-sunny', 'weather-cloudy');
      clearWeatherAnimation();

      // Glassãƒ†ãƒ¼ãƒä»¥å¤–ã§ã®ã¿èƒŒæ™¯è‰²ã‚’å¤‰æ›´
      if (currentTheme !== 'glass') {
        if (code === 0 || code === 1) { 
            body.classList.add('weather-sunny');
        } else if (code <= 3 || code === 45 || code === 48) { 
            body.classList.add('weather-cloudy');
        }
      }

      if ([71, 73, 75, 77, 85, 86].includes(code)) { // é›ª
          startSnowAnimation(container);
      } else if (code > 3) { // é›¨ãƒ»ãã®ä»–
          startRainAnimation(container);
      }
  }

  function clearWeatherAnimation() {
      if (weatherAnimInterval) {
          clearInterval(weatherAnimInterval);
          weatherAnimInterval = null;
      }
      document.getElementById('weather-animation-container').innerHTML = '';
  }

  function startRainAnimation(container) {
      weatherAnimInterval = setInterval(() => {
          const drop = document.createElement('div');
          drop.classList.add('rain-drop');
          drop.style.left = Math.random() * 100 + 'vw';
          drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
          container.appendChild(drop);
          setTimeout(() => { drop.remove(); }, 1000);
      }, 50);
  }

  function startSnowAnimation(container) {
      weatherAnimInterval = setInterval(() => {
          const flake = document.createElement('div');
          flake.classList.add('snow-flake');
          flake.style.left = Math.random() * 100 + 'vw';
          flake.style.opacity = Math.random();
          flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
          container.appendChild(flake);
          setTimeout(() => { flake.remove(); }, 5000);
      }, 200);
  }

  function getWmoWeatherIcon(code) {
    if (code === 0) return "â˜€ï¸";
    if ([1, 2, 3].includes(code)) return "â›…ï¸";
    if ([45, 48].includes(code)) return "ğŸŒ«ï¸";
    if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return "â˜‚ï¸";
    if ([71, 73, 75, 77, 85, 86].includes(code)) return "â˜ƒï¸";
    if (code >= 95) return "âš¡ï¸";
    return "â˜ï¸";
  }
  
  function getWmoWeatherText(code) {
    if (code === 0) return "æ™´å¤©";
    if ([1, 2, 3].includes(code)) return "ãã‚‚ã‚Š"; 
    if ([45, 48].includes(code)) return "éœ§";
    if ([51, 53, 55].includes(code)) return "éœ§é›¨";
    if ([61, 63, 65].includes(code)) return "é›¨";
    if ([71, 73, 75, 77].includes(code)) return "é›ª";
    if ([80, 81, 82].includes(code)) return "ã«ã‚ã‹é›¨";
    if ([85, 86].includes(code)) return "é›ª";
    if (code >= 95) return "é›·é›¨";
    return "--";
  }

  function setupRealtimeListener() {
    const dataPath = `users/${currentUser}/${currentMeal}`;
    const dataRef = window.ref(window.db, dataPath);

    window.onValue(dataRef, (snapshot) => {
      const val = snapshot.val();
      if (val) {
        currentFirebaseData = val;
      } else {
        currentFirebaseData = { checks: {}, otherFinish: '', otherLeft: '' };
      }
      renderPage(); 
      updateChartAndScore(); 
    });
  }

  async function loadMenuCsv() {
    try {
      const response = await fetch('menu.csv?' + new Date().getTime());
      if (!response.ok) throw new Error("CSV error");
      const text = await response.text();
      parseCsv(text);
    } catch (e) {
      document.getElementById('list-container').innerHTML = `<div style="text-align:center; margin-top:20px; color:var(--text-sub);">menu.csvèª­è¾¼ã‚¨ãƒ©ãƒ¼</div>`;
    }
  }

  function parseCsv(text) {
    const lines = text.split(/\r\n|\n/);
    menuData = { morning: {}, dinner: {} };
    nutritionMap = {};
    
    Object.values(CATEGORY_MAP).forEach(cat => { menuData.morning[cat] = []; menuData.dinner[cat] = []; });
    
    lines.forEach(line => {
      const parts = line.split(',');
      if (parts.length < 6) return;
      const [m, c, item, y, r, g] = parts;
      const catName = CATEGORY_MAP[c.trim()];
      
      if (!catName) return;
      const itemName = item.trim();

      if (m.trim() === '1') menuData.morning[catName].push(itemName);
      else if (m.trim() === '2') menuData.dinner[catName].push(itemName);

      nutritionMap[itemName] = {
        yellow: parseInt(y) || 0,
        red: parseInt(r) || 0,
        green: parseInt(g) || 0
      };
    });
  }

  function renderPage() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${currentMeal}`).classList.add('active');
    
    const partnerBtn = document.getElementById('btn-partner-copy');
    // çµµæ–‡å­—ã‚’å«ã‚€HTMLã‚’ã‚»ãƒƒãƒˆ
    partnerBtn.innerHTML = `<span class="emoji-toned">ğŸ“‹</span> ${currentUser === 'boy' ? 'ğŸµã¸ã‚³ãƒ”ãƒ¼' : 'ğŸŒ™ã¸ã‚³ãƒ”ãƒ¼'}`;

    const container = document.getElementById('list-container');
    container.innerHTML = '';
    
    const savedData = currentFirebaseData;
    const checks = savedData.checks || {};

    Object.values(CATEGORY_MAP).forEach(catName => {
      const items = menuData[currentMeal][catName];
      if (!items || items.length === 0) return;

      const title = document.createElement('div');
      title.className = 'category-title';
      title.textContent = catName;
      container.appendChild(title);

      const card = document.createElement('div');
      card.className = 'list-card';

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item-row';
        const savedVal = checks[item] || 'none';
        const radioName = `radio_${item}`;

        row.innerHTML = `
          <div class="item-name">${item}</div>
          <div class="options">
            <label><input type="radio" name="${radioName}" value="finish" 
              ${savedVal === 'finish' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">å®Œé£Ÿ</span></label>
            <label><input type="radio" name="${radioName}" value="left" 
              ${savedVal === 'left' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">æ®‹ã—</span></label>
            <label><input type="radio" name="${radioName}" value="none" 
              ${savedVal === 'none' ? 'checked' : ''} onchange="saveData()">
              <span class="radio-label">â€•</span></label>
          </div>
        `;
        card.appendChild(row);
      });
      container.appendChild(card);
    });

    const ofInput = document.getElementById('other-finish');
    const olInput = document.getElementById('other-left');
    if (document.activeElement !== ofInput) ofInput.value = savedData.otherFinish || '';
    if (document.activeElement !== olInput) olInput.value = savedData.otherLeft || '';
  }

  function initChart() {
    const ctx = document.getElementById('nutritionChart').getContext('2d');
    
    myChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['ğŸ’›ã‚¨ãƒãƒ«ã‚®ãƒ¼', 'â¤ï¸ã‹ã‚‰ã ä½œã‚Š', 'ğŸ’šèª¿å­ã‚’æ•´ãˆã‚‹'],
        datasets: [{
          label: 'æ‘‚å–ãƒãƒ©ãƒ³ã‚¹',
          data: [0, 0, 0],
          backgroundColor: 'rgba(0, 122, 255, 0.2)',
          borderColor: 'rgba(0, 122, 255, 1)',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: ['#D4A056', '#C26D6D', '#699B7E'], /* ã‚°ãƒ©ãƒ•è‰²ã‚‚ãã™ã¿ã‚«ãƒ©ãƒ¼ã« */
          pointBorderColor: '#fff',
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 5 },
        scales: {
          r: {
            angleLines: { display: true, color: '#E5E5EA' },
            suggestedMin: 0,
            suggestedMax: 8,
            pointLabels: {
              font: { size: 13, weight: '600' },
              color: '#8E8E93' 
            },
            ticks: { display: false, stepSize: 2 },
            grid: { color: '#E5E5EA' } 
          }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  function updateChartAndScore() {
    if (!myChart) return;

    let totalY = 0;
    let totalR = 0;
    let totalG = 0;

    const checks = currentFirebaseData.checks || {};

    Object.keys(checks).forEach(item => {
      if (checks[item] === 'finish' && nutritionMap[item]) {
        totalY += nutritionMap[item].yellow;
        totalR += nutritionMap[item].red;
        totalG += nutritionMap[item].green;
      }
    });

    myChart.data.datasets[0].data = [totalY, totalR, totalG];
    
    // ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸè‰²èª¿æ•´ï¼ˆCSSå¤‰æ•°ã‹ã‚‰å–å¾—ã—ã¦é©ç”¨ï¼‰
    const rootStyles = getComputedStyle(document.documentElement);
    const accentColorHex = currentUser === 'boy' 
       ? rootStyles.getPropertyValue('--color-boy').trim()
       : rootStyles.getPropertyValue('--color-girl').trim();
    
    // HEX to RGB å¤‰æ›
    let r=0, g=0, b=0;
    if(accentColorHex.startsWith('#')) {
        const hex = accentColorHex.slice(1);
        r = parseInt(hex.substring(0,2), 16);
        g = parseInt(hex.substring(2,4), 16);
        b = parseInt(hex.substring(4,6), 16);
    }

    myChart.data.datasets[0].backgroundColor = `rgba(${r}, ${g}, ${b}, 0.2)`;
    myChart.data.datasets[0].borderColor = `rgba(${r}, ${g}, ${b}, 1)`;
    
    // ãƒãƒ£ãƒ¼ãƒˆã®ã‚°ãƒªãƒƒãƒ‰è‰²ãªã©ã‚’ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦å¾®èª¿æ•´
    const isDark = currentTheme === 'glass' && window.matchMedia('(prefers-color-scheme: dark)').matches; 
    const gridColor = isDark ? 'rgba(255,255,255,0.1)' : '#E5E5EA';
    const labelColor = isDark ? 'rgba(255,255,255,0.6)' : '#8E8E93';

    myChart.options.scales.r.grid.color = gridColor;
    myChart.options.scales.r.angleLines.color = gridColor;
    myChart.options.scales.r.pointLabels.color = labelColor;

    myChart.update();

    const totalScore = totalY + totalR + totalG;
    const scoreTextEl = document.getElementById('score-text');
    const commentEl = document.getElementById('score-comment');
    
    scoreTextEl.innerHTML = `${totalScore} <span style="font-size:1.2rem;">pt</span>`;

    let comment = "";
    if (totalScore === 0) {
        comment = "ä½•ã‚’é£Ÿã¹ã‚‹ã‹ãªï¼Ÿ";
    } else if (totalScore < 5) {
        comment = "ã‚‚ã†å°‘ã—é£Ÿã¹ã‚ˆã†ï¼ğŸ™";
    } else if (totalScore < 10) {
        comment = "è‰¯ã„èª¿å­ï¼ãã®èª¿å­ğŸ‘";
    } else if (totalScore < 15) {
        comment = "ãƒŠã‚¤ã‚¹ãƒãƒ©ãƒ³ã‚¹ï¼ç´ æ™´ã‚‰ã—ã„âœ¨";
    } else {
        comment = "ã‚¨ãƒãƒ«ã‚®ãƒ¼æº€ã‚¿ãƒ³ï¼å…ƒæ°—100å€ğŸ’ª";
    }
    commentEl.textContent = comment;
  }

  function switchUser(user) {
    currentUser = user;
    localStorage.setItem('fc_last_user', user);
    updateTheme();
    setupRealtimeListener(); 
  }

  function switchMeal(meal) {
    currentMeal = meal;
    setupRealtimeListener(); 
  }

  function updateTheme() {
    document.body.setAttribute('data-user', currentUser);
    if(myChart) updateChartAndScore(); 
  }

  function saveData() {
    const data = {
      checks: {},
      otherFinish: document.getElementById('other-finish').value,
      otherLeft: document.getElementById('other-left').value
    };

    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
      const itemName = input.name.replace('radio_', '');
      data.checks[itemName] = input.value;
    });

    const dataPath = `users/${currentUser}/${currentMeal}`;
    window.set(window.ref(window.db, dataPath), data);
  }

  function showResetModal() {
    document.getElementById('reset-modal').style.display = 'flex';
  }
  function closeModal() {
    document.getElementById('reset-modal').style.display = 'none';
  }

  function showNutritionHelp() {
    document.getElementById('nutrition-modal').style.display = 'flex';
  }
  function closeNutritionModal() {
    document.getElementById('nutrition-modal').style.display = 'none';
  }

  function resetCurrent() {
    closeModal();
    const userName = currentUser === 'boy' ? 'ç”·ã®å­' : 'å¥³ã®å­';
    const mealName = currentMeal === 'morning' ? 'æœé£Ÿ' : 'å¤•é£Ÿ';
    if(!confirm(`ã€Œ${userName}ã€ã®ã€Œ${mealName}ã€ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const dataPath = `users/${currentUser}/${currentMeal}`;
    window.set(window.ref(window.db, dataPath), null);
  }

  function resetAll() {
    closeModal();
    if(!confirm("ã€æ³¨æ„ã€‘\nå…¨å“¡ã®å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
    const dataPath = `users`;
    window.set(window.ref(window.db, dataPath), null);
  }

  function copyToPartner() {
    const targetUser = currentUser === 'boy' ? 'girl' : 'boy';
    const targetName = currentUser === 'boy' ? 'å¥³ã®å­' : 'ç”·ã®å­';
    const mealName = currentMeal === 'morning' ? 'æœé£Ÿ' : 'å¤•é£Ÿ';
    if(!confirm(`ç¾åœ¨è¡¨ç¤ºä¸­ã®å†…å®¹ã‚’\nã€Œ${targetName}ã€ã®ã€Œ${mealName}ã€ã«\nä¸Šæ›¸ãã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const sourcePath = `users/${currentUser}/${currentMeal}`;
    const targetPath = `users/${targetUser}/${currentMeal}`;
    window.get(window.ref(window.db, sourcePath)).then((snapshot) => {
      if (snapshot.exists()) {
        window.set(window.ref(window.db, targetPath), snapshot.val());
        alert(`ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
      } else {
        alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      }
    });
  }

  function generateAndCopy() {
    const ICON_FINISH = "â­•ï¸";
    const ICON_LEFT   = "ğŸ”º"; 
    
    const savedData = currentFirebaseData;
    const checks = savedData.checks || {};
    
    let resultLines = [];
    
    Object.keys(CATEGORY_MAP).forEach(key => {
        const catName = CATEGORY_MAP[key];
        const items = menuData[currentMeal][catName];
        
        if (!items) return;

        items.forEach(itemName => {
            const val = checks[itemName];
            if (val === 'finish') {
                resultLines.push(`ã€${catName}ã€‘${ICON_FINISH}${itemName}`);
            } else if (val === 'left') {
                resultLines.push(`ã€${catName}ã€‘${ICON_LEFT}${itemName}`);
            }
        });
    });

    const otherF = savedData.otherFinish;
    const otherL = savedData.otherLeft;
    if(otherF) resultLines.push(`ã€ãã®ä»–ã€‘${ICON_FINISH}${otherF}`);
    if(otherL) resultLines.push(`ã€ãã®ä»–ã€‘${ICON_LEFT}${otherL}`);

    if(resultLines.length === 0) {
       alert("é¸æŠã•ã‚ŒãŸé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“");
       return;
    }

    let resultText = resultLines.join("\n");

    if (navigator.clipboard) {
        navigator.clipboard.writeText(resultText).then(() => {
            if(confirm("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã‚³ãƒ‰ãƒ¢ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰ã‚’èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ")) {
                window.open('https://parents.codmon.com/contact', '_blank');
            }
        });
    } else {
        const ta = document.createElement('textarea');
        ta.value = resultText;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        if(confirm("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã‚³ãƒ‰ãƒ¢ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰ã‚’èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ")) {
            window.open('https://parents.codmon.com/contact', '_blank');
        }
    }
  }
</script>
</body>
</html>
